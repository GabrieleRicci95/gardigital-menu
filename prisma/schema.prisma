generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?  // Nome completo
  password  String
  role      String   @default("OWNER") // "ADMIN", "OWNER", "USER"
  
  resetToken       String?
  resetTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurants Restaurant[]
}

model Restaurant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?

  themeColor  String   @default("#1a237e") 
  
  coverImageUrl   String?
  backgroundColor String   @default("#ffffff")
  textColor       String   @default("#000000")
  fontFamily      String   @default("inter") // "inter", "playfair", "roboto", "lato", "montserrat"
  
  whatsappNumber  String?  // Added for Reservation System
  wineListUrl     String?  // URL to Wine List PDF or Image
  googleReviewsUrl String? // Link to Google Business Reviews
  
  cardStyle       String   @default("minimal") // "minimal", "shadow", "border", "glass"
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  
  menus       Menu[]
  subscription Subscription?
  // VISITS: Added for Analytics
  visits      Visit[]
  fixedMenus  FixedMenu[]
  wineList    WineList?
  champagneList ChampagneList?
  drinkList   DrinkList?
  customLists CustomList[]
  reservations Reservation[] // Added for Reservation System
  translations RestaurantTranslation[]

  // Booking Configuration
  bookingMaxGuestsPerSlot Int     @default(10)
  bookingAutoConfirm      Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RestaurantTranslation {
    id          String   @id @default(cuid())
    language    String   // "en", "de", "fr", "es"
    description String?  @db.Text
    
    restaurantId String
    restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

    @@unique([restaurantId, language])
}

model Menu {
  id           String     @id @default(cuid())
  name         String
  isActive     Boolean    @default(false)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  categories   Category[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Category {
  id           String     @id @default(cuid())
  name         String
  sortOrder    Int        @default(0)
  menuId       String
  menu         Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  
  items        MenuItem[]
  translations CategoryTranslation[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model MenuItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal?
  imageUrl    String?
  isVisible   Boolean  @default(true)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  allergens    String? // JSON string
  isVegan      Boolean @default(false)
  isGlutenFree Boolean @default(false)
  isVegetarian Boolean @default(false)
  spiciness    Int     @default(0)
  priceUnit    String? // e.g. "cad", "/hg", etc.

  translations MenuItemTranslation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime   @updatedAt
}

model Subscription {
  id             String     @id @default(cuid())
  plan           String     @default("BASE") // "BASE", "PREMIUM", "FULL"
  status         String     @default("ACTIVE") // "ACTIVE", "EXPIRED"
  
  // Feature Flags (Micro-services)
  hasTranslations Boolean    @default(false)
  hasReservations Boolean    @default(false)
  hasOrders       Boolean    @default(false)

  startDate      DateTime   @default(now())
  endDate        DateTime?
  restaurantId   String     @unique
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}


model MenuItemTranslation {
  id          String   @id @default(cuid())
  language    String   // "en", "de", "fr", "es"
  name        String
  description String?
  
  menuItemId  String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, language])
}

model CategoryTranslation {
    id          String   @id @default(cuid())
    language    String   // "en", "de", "fr", "es"
    name        String

    categoryId  String
    category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@unique([categoryId, language])
}

model Visit {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
}

model FixedMenu {
  id           String     @id @default(cuid())
  name         String
  subtitle     String?    // Short description under title
  price        Decimal
  description  String?
  isActive     Boolean    @default(true)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sections     FixedMenuSection[]
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model FixedMenuSection {
  id           String     @id @default(cuid())
  name         String     // e.g. "Antipasti", "Primi"
  description  String?    // e.g. "6 Portate..."
  fixedMenuId  String
  fixedMenu    FixedMenu  @relation(fields: [fixedMenuId], references: [id], onDelete: Cascade)
  items        FixedMenuItem[]
  
  sortOrder    Int        @default(0) // To control order of sections
}

model FixedMenuItem {
  id                 String           @id @default(cuid())
  name               String
  description        String?
  allergens          String?          // JSON string storing array of allergen IDs
  fixedMenuSectionId String
  fixedMenuSection   FixedMenuSection @relation(fields: [fixedMenuSectionId], references: [id], onDelete: Cascade)
}

model WineList {
  id           String            @id @default(cuid())
  isActive     Boolean           @default(true)
  restaurantId String            @unique
  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sections     WineListSection[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model WineListSection {
  id          String     @id @default(cuid())
  name        String     // e.g. "Vini Rossi", "Bollicine"
  sortOrder   Int        @default(0)
  wineListId  String
  wineList    WineList   @relation(fields: [wineListId], references: [id], onDelete: Cascade)
  items       WineItem[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model WineItem {
  id                String          @id @default(cuid())
  name              String
  description       String?         // e.g. "Cantina X, Annata 2020"
  price             Decimal
  wineListSectionId String
  wineListSection   WineListSection @relation(fields: [wineListSectionId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model ChampagneList {
  id           String            @id @default(cuid())
  isActive     Boolean           @default(true)
  restaurantId String            @unique
  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sections     ChampagneSection[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model ChampagneSection {
  id              String     @id @default(cuid())
  name            String     // e.g. "Magnum", "Ros√©"
  sortOrder       Int        @default(0)
  champagneListId String
  champagneList   ChampagneList @relation(fields: [champagneListId], references: [id], onDelete: Cascade)
  items           ChampagneItem[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model ChampagneItem {
  id                  String          @id @default(cuid())
  name                String
  description         String?
  price               Decimal
  champagneSectionId  String
  champagneSection    ChampagneSection @relation(fields: [champagneSectionId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
}

model DrinkList {
  id           String            @id @default(cuid())
  isActive     Boolean           @default(true)
  restaurantId String            @unique
  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sections     DrinkSection[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model DrinkSection {
  id          String     @id @default(cuid())
  name        String     // e.g. "Cocktail", "Bibite"
  sortOrder   Int        @default(0)
  drinkListId String
  drinkList   DrinkList   @relation(fields: [drinkListId], references: [id], onDelete: Cascade)
  items       DrinkItem[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model DrinkItem {
  id                String          @id @default(cuid())
  name              String
  description       String?
  price             Decimal
  logoUrl           String?         // URL for drink logo (e.g. Gin brand)
  drinkSectionId    String
  drinkSection      DrinkSection @relation(fields: [drinkSectionId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model Reservation {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name          String    // Customer Name
  email         String?
  phone         String?
  
  guests        Int
  date          DateTime  // Date and Time of reservation
  
  status        String    @default("PENDING") // PENDING, CONFIRMED, REJECTED, CANCELLED
  notes         String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model CustomList {
  id           String            @id @default(cuid())
  name         String            // e.g. "Carta dei Dessert"
  slug         String            // e.g. "dessert"
  isActive     Boolean           @default(true)
  restaurantId String
  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sections     CustomListSection[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@unique([restaurantId, slug])
}

model CustomListSection {
  id           String     @id @default(cuid())
  name         String
  sortOrder    Int        @default(0)
  customListId String
  customList   CustomList @relation(fields: [customListId], references: [id], onDelete: Cascade)
  items        CustomListItem[]
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model CustomListItem {
  id                  String            @id @default(cuid())
  name                String
  description         String?
  price               Decimal
  imageUrl            String?
  customListSectionId String
  customListSection   CustomListSection @relation(fields: [customListSectionId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}
